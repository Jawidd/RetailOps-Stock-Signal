AWSTemplateFormatVersion: "2010-09-09"
Description: >- 
  GLUE DATABASE
  GLUE TABLES (inventory,products,sales,shipments,stores,suppliers
  Athena Workgroup (query result location, encryption ...)
  Bucket for athena results
  IAM permissions (for Athena/Glue/S3 access)
  NOTE: all datatypes are string to avoid CSV parsing


Parameters:
  ProjectNameInput:
    Type: String
    Default: "retailops"

Resources:
  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput: 
        Name: retailops
        LocationUri: !ImportValue retailops-DataLakeBucketURI


  # s3 bucket for AThena Results
  AthenaQueryResultsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${ProjectNameInput}-athena-query-results-${AWS::Region}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # athena workgroup to enforce output dir and encryption
  RetailOpsAthenaWorkGroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: retailops-primary
      Description: RetailOps Athena workgroup to enforce output dir and encryption
      State: ENABLED
      WorkGroupConfiguration:
        EnforceWorkGroupConfiguration: true
        PublishCloudWatchMetricsEnabled: true
        ResultConfiguration:
          OutputLocation: !Sub
            - "s3://${ResultsBucket}/"
            - ResultsBucket: !Ref AthenaQueryResultsBucket
          EncryptionConfiguration:
            EncryptionOption: SSE_S3       




  
  # RAW Products Table/Dimension
  RawProductsTable:
    Type: AWS::Glue::Table
    DependsOn: GlueDatabase
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: retailops
      TableInput: 
        Name: raw_products
        TableType: EXTERNAL_TABLE
        Parameters:
          skip.header.line.count: "1"
          classification: "csv"
        StorageDescriptor:
          Location: !Sub
            - "${BucketUri}/raw/products/"
            - BucketUri: !ImportValue retailops-DataLakeBucketURI
          InputFormat: "org.apache.hadoop.mapred.TextInputFormat"
          OutputFormat: "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat"
          SerdeInfo:
            SerializationLibrary: "org.apache.hadoop.hive.serde2.OpenCSVSerde"
            Parameters:
              separatorChar: ","
              quoteChar: "\""
              escapeChar: "\\"
          Columns:
            - Name: product_id
              Type: string
            - Name: product_name
              Type: string
            - Name: category
              Type: string
            - Name: sub_category
              Type: string
            - Name: unit_cost
              Type: string
            - Name: unit_price
              Type: string
            - Name: supplier_id
              Type: string
            - Name: is_active
              Type: string

  # RAW Stores Table/Dimension
  RawStoresTable:
      Type: AWS::Glue::Table
      DependsOn: GlueDatabase
      Properties:
        CatalogId: !Ref AWS::AccountId
        DatabaseName: retailops
        TableInput:
          Name: raw_stores
          TableType: EXTERNAL_TABLE
          Parameters:
            skip.header.line.count: "1"
            classification: "csv"
          StorageDescriptor:
            Location: !Sub
              - "${BucketUri}/raw/stores/"
              - BucketUri: !ImportValue retailops-DataLakeBucketURI
            InputFormat: org.apache.hadoop.mapred.TextInputFormat
            OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
            SerdeInfo:
              SerializationLibrary: org.apache.hadoop.hive.serde2.OpenCSVSerde
              Parameters:
                separatorChar: ","
                quoteChar: "\""
                escapeChar: "\\"
            Columns:
              - Name: store_id
                Type: string
              - Name: store_name
                Type: string
              - Name: region
                Type: string
              - Name: store_type
                Type: string
              - Name: sq_footage
                Type: string
              - Name: opened_date
                Type: string 

  # RAW Suppliers Table/Dimension
  RawSuppliersTable:
    Type: AWS::Glue::Table
    DependsOn: GlueDatabase
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: retailops
      TableInput:
        Name: raw_suppliers
        TableType: EXTERNAL_TABLE
        Parameters:
          skip.header.line.count: "1"
          classification: "csv"
        StorageDescriptor:
          Location: !Sub
            - "${BucketUri}/raw/suppliers/"
            - BucketUri: !ImportValue retailops-DataLakeBucketURI
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.OpenCSVSerde
            Parameters:
              separatorChar: ","
              quoteChar: "\""
              escapeChar: "\\"
          Columns:
            - Name: supplier_id
              Type: string
            - Name: supplier_name
              Type: string
            - Name: lead_time_days
              Type: string  
            - Name: on_time_rate
              Type: string
            - Name: country
              Type: string

  # RAW Sales Facts
  RawSalesTable:
    Type: AWS::Glue::Table
    DependsOn: GlueDatabase
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: retailops
      TableInput:
        Name: raw_sales
        TableType: EXTERNAL_TABLE
        Parameters:
          skip.header.line.count: "1"
          classification: "csv"
          projection.enabled: "true"
          projection.dt.type: "date"
          projection.dt.range: "2024-07-01,NOW"
          projection.dt.format: "yyyy-MM-dd"
          storage.location.template: !Join
            - ""
            - - !ImportValue retailops-DataLakeBucketURI
              - "/raw/sales/dt=${dt}/"
        PartitionKeys:
          - Name: dt
            Type: string
        StorageDescriptor:
          Location: !Sub
            - "${BucketUri}/raw/sales/"
            - BucketUri: !ImportValue retailops-DataLakeBucketURI
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.OpenCSVSerde
            Parameters:
              separatorChar: ","
              quoteChar: "\""
              escapeChar: "\\"
          Columns:
            - Name: sale_id
              Type: string
            - Name: sale_date
              Type: string
            - Name: store_id
              Type: string
            - Name: product_id
              Type: string
            - Name: quantity_sold
              Type: string
            - Name: unit_price
              Type: string
            - Name: discount_amount
              Type: string
            - Name: total_amount
              Type: string

    # RAW Inventory  Facts
  RawInventoryTable:
    Type: AWS::Glue::Table
    DependsOn: GlueDatabase
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: retailops
      TableInput:
        Name: raw_inventory
        TableType: EXTERNAL_TABLE
        Parameters:
          skip.header.line.count: "1"
          classification: "csv"
          projection.enabled: "true"
          projection.dt.type: "date"
          projection.dt.range: "2024-07-01,NOW"
          projection.dt.format: "yyyy-MM-dd"
          storage.location.template: !Join
            - ""
            - - !ImportValue retailops-DataLakeBucketURI
              - "/raw/inventory/dt=${dt}/"
        PartitionKeys:
          - Name: dt
            Type: string
        StorageDescriptor:
          Location: !Sub
            - "${BucketUri}/raw/inventory/"
            - BucketUri: !ImportValue retailops-DataLakeBucketURI
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.OpenCSVSerde
            Parameters:
              separatorChar: ","
              quoteChar: "\""
              escapeChar: "\\"
          Columns:
            - Name: snapshot_date
              Type: string
            - Name: store_id
              Type: string
            - Name: product_id
              Type: string
            - Name: quantity_on_hand
              Type: string
            - Name: quantity_on_order
              Type: string
            - Name: reorder_point
              Type: string
            - Name: last_restock_date
              Type: string

  # RAW Shipment Facts
  RawShipmentsTable:
    Type: AWS::Glue::Table
    DependsOn: GlueDatabase
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: retailops
      TableInput:
        Name: raw_shipments
        TableType: EXTERNAL_TABLE
        Parameters:
          skip.header.line.count: "1"
          classification: "csv"
          projection.enabled: "true"
          projection.dt.type: "date"
          projection.dt.range: "2024-07-01,NOW"
          projection.dt.format: "yyyy-MM-dd"
          storage.location.template: !Join
            - ""
            - - !ImportValue retailops-DataLakeBucketURI
              - "/raw/shipments/dt=${dt}/"
        PartitionKeys:
          - Name: dt
            Type: string
        StorageDescriptor:
          Location: !Sub
            - "${BucketUri}/raw/shipments/"
            - BucketUri: !ImportValue retailops-DataLakeBucketURI
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.serde2.OpenCSVSerde
            Parameters:
              separatorChar: ","
              quoteChar: "\""
              escapeChar: "\\"
          Columns:
            - Name: shipment_id
              Type: string
            - Name: order_date
              Type: string
            - Name: expected_date
              Type: string
            - Name: received_date
              Type: string
            - Name: store_id
              Type: string
            - Name: product_id
              Type: string
            - Name: supplier_id
              Type: string
            - Name: quantity_ordered
              Type: string
            - Name: quantity_received
              Type: string
            - Name: is_late
              Type: string





Outputs:
  GlueDatabaseName:
    Description: GlueDatabaseName
    Value: !Ref GlueDatabase
   
  AthenaQueryResultsBucketName:
    Description: AthenaQueryResultsBucketName
    Value: !Ref AthenaQueryResultsBucket
    Export: 
      Name: AthenaQueryResultsBucketName
  AthenaQueryResultsBucketARN:
    Description: AthenaQueryResultsBucketARN
    Value: !GetAtt AthenaQueryResultsBucket.Arn
    Export:
      Name: AthenaQueryResultsBucketARN
  AthenaQueryResultsBucketURI:
    Description: AthenaQueryResultsBucketURI
    Value:   !Sub "s3://${AthenaQueryResultsBucket}"
    Export:
      Name: AthenaQueryResultsBucketURI
  
  RetailOpsAthenaWorkGroupName:
    Description: RetailOpsAthenaWorkGroupName
    Value: !Ref RetailOpsAthenaWorkGroup
    Export:
      Name: retailops-AthenaWorkGroupName

 

  RawProductsTableName:
    Description: RawProducts Table/dimension Name
    Value: !Ref RawProductsTable

  RawStoresTableName:
    Description:  RawStores Table/dimension Name
    Value: !Ref RawStoresTable
  
  RawSuppliersTableName:
    Description:  RawSuppliers Table/dimension Name
    Value: !Ref RawSuppliersTable
  
  RawSalesTableName:
    Description:  RawSales Fact Name
    Value: !Ref RawSalesTable

  RawInventoryTableName:
    Description:  RawInventory Fact Name
    Value: !Ref RawInventoryTable

  RawShipmentsTableName:
    Description:  RawShipments Fact Name
    Value: !Ref RawShipmentsTable

  